<?php

/*
	Malware_Scanner 1.0 BETA, No malware codes after day !
	Copyright (C)  Ahmed Hosny < http://AhmedHosny.com >
												
	This program is free software: you can redistribute it and/or modify
	it under the terms of the GNU General Public License as published by
	the Free Software Foundation, either version 3 of the License, or
	(at your option) any later version.						
													
	This program is distributed in the hope that it will be useful,	
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU General Public License for more details.					

	You should have received a copy of the GNU General Public License	
	along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

// PATH to scan
define("PATH", "/var/www/malware-scanner/");

// SIGNATURE to look for and replace
$signature = <<<SIG
<script>BAD CODE HERE !!</script>
SIG;

define("SIGNATURE", $signature);

class malware_scanner {
	
	function __construct()
	{
		$this->list_folders_files(PATH);
	}
	
	// List all files in the directory ( Recursive )
	function list_folders_files($path = PATH)
	{
		$files_folders = scandir($path);

		//var_dump($files_folders);

		foreach($files_folders as $file_folder)
		{
			if(is_dir($file_folder) && $file_folder != "." && $file_folder != "..")
				{
					$this->list_folders_files($path . $file_folder . "/");
				}
				
			else if(is_file($path ."/". $file_folder))
				{
					$this->scan_file($path . $file_folder);
				}
		}

	}
	
	// Scan the file for malware signatures
	function scan_file($file)
	{
		print "<li>Scanning: <b>$file</b> ..";
		$f = fopen($file, "r");
		$res = @fread($f, filesize($file));
		if(strpos($res, SIGNATURE) > -1)
			{
				print "<ul>";
				print "<li><font color='brown'>Infected !</font></li>";
				print "<li><font color='blue'>Trying to repair ..</font></li>";
				if($this->repair_file($file) === "repaired")
					print "<li><font color='green'>Repaired ! ..</font></li>";
				else
					print "<li><font color='red'>Repair Failed !! ..</font></li>";
				print "</ul>";
			}
		else
			{
				print "<ul>";
				print "<li><font color='green'>Clean.</font></li>";
				print "</ul>";
			}
		
		fclose($f);
		print "</li><hr>";
	}
	
	function repair_file($file)
	{
		$f = fopen($file, "r");
		$res = @fread($f, filesize($file));
		if(strpos($res, SIGNATURE) > -1)
			$res1 = str_replace(SIGNATURE, "", $res);
		fclose($f);
		
		$f = fopen($file, "w");
		fwrite($f, $res1);
		fclose($f);
		
		$f = fopen($file, "r");
		$res = @fread($f, filesize($file));
		if(strpos($res, SIGNATURE) > -1)
			return "not_repaired";
		else
			return "repaired";
		fclose($f);
	}

}

print "<center><font size='5' color='darkgreen'><b>Malware Scanner</b></font><br><small>Created By: <a href='http://www.AhmedHosny.com'>Ahmed Hosny</a></small></center><hr>";

$m = new malware_scanner;

print "<center><small>Created By: <a href='http://www.AhmedHosny.com'>Ahmed Hosny</a></small></center>";

?>
